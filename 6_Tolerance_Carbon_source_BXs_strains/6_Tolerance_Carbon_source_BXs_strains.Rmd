---
title: "Tolerance & Carbon source SynCom strains"
subtitle: "Thoenen et al. BX SynComs"
author: "Lisa Thoenen"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
rm(list = ls())
```


**set working directory to source file location**

```{r, warning=FALSE, include=FALSE}
# install.packages("MESS")
# #Plotly to annotate plots and explore them
# #install.packages("plotly")
# install.packages("metacoder")
# 
# #lme4 and lmertest for stats, multcomp and lsmeans for posthoc
# install.packages("lme4")
# install.packages("lmerTest")
# install.packages("multcomp")
# install.packages("emmeans")
# install.packages("magrittr")
# install.packages("readxl")
# install.packages("lme4")
# install.packages("lmerTest")
# install.packages("multcomp")
# install.packages("emmeans")Single_strain_abundance_SynCom
# 
# #Formatting and reading tools
# install.packages("magrittr")
# install.packages("tidyverse")
# install.packages("readxl")
# install.packages("lubridate")
# install.packages("broom")
# install.packages("dplyr")
# install.packages("tidyr")
# install.packages("stringr")
# install.packages("readr")
# install.packages("purrr")
# 
# #Plotstuff
# install.packages("ggthemes")
# install.packages("ggforce")
# install.packages("KEGGREST")
# install.packages("randomForest")
# install.packages("ggplot2")
# install.packages("rstatix")
```

1. Library loading, setting up misc functions
```{r, warning=FALSE, include=FALSE}
#MESS for AUC function
library("MESS")
#Plotly to annotate plots and explore them
#library("plotly")

library("metacoder")

#lme4 and lmertest for stats, multcomp and lsmeans for posthoc
library("lme4")
library("lmerTest")
library("multcomp")
library("emmeans")
#Formatting and reading tools
library("magrittr")
#library("tidyverse")
library("readxl")
library("lubridate")
library("broom")
library("dplyr")
library("tidyr")
library("stringr")
library("readr")
library("purrr")
library("rstatix")
### the dplyr package gets overwritten by other packages so often it is necessary to load it specifically again when needed for exapmle like that: dplyr::select
#Plotstuff
library("ggthemes")
library("ggforce")
#library("KEGGREST")
#library("randomForest")
library("ggpubr")
library("ggbeeswarm")

```

2. Metadata
```{r, warning=FALSE, include=FALSE}
Strain_Data <- read_excel("./Input/6_Metadata_Tolerance_Carbon_SynCom.xlsx")

database <- read.csv("./Input/6_Metadata_tolerance_carbon_source.csv")

Strain_Data <- left_join(Strain_Data, database, by = "Strain") %>%
  dplyr::select(Sample_name, Strain, Column, Row, Well, Replicate, Plate, Phylum, Class, Order, Family, Genus, ZOTU, Morphology_MBOA)

Strain_Data$Well_Plate <- interaction(Strain_Data$Well, Strain_Data$Plate, sep = "_")

Strain_Data %<>% dplyr::rename(Strain_pure = Strain,
                              Strain = Sample_name)
```

```{r, warning=FALSE, include=FALSE}
symnum.args <- list(cutpoints = c(0, 0.05, 1), symbols = c("*", "ns"))
```

3. Load raw growth data
```{r, warning=FALSE, include=FALSE}
results <- data_frame()

# Provide a lookup table for plate information, treatments are spread accross sheets in the table to be read.
# in the first column describe the plates and in the second column the experiment (rep(times = # plates - 2))
treatlist1 <- data_frame("Treat" =
              c("Dummy1",
                "DMSO_500__pure_strains_TSB",
                "BOA_500_pure_strains_TSB",
                "MBOA_500_pure_strains_TSB",
                "DMG_500_pure_strains_TSB",
                "AMPO_30_pure_strains_TSB",
                "BOA_2500_pure_strains_TSB",
                "MBOA_2500_pure_strains_TSB",
                "DMG_2500_pure_strains_TSB",
                "AMPO_180_pure_strains_TSB",
                "DMSO_minimal_media",
                "AMPO_30_minimal_media",
                "BOA_500_minimal_media",
                "MBOA_500_minimal_media",
                "DMG_500_minimal_media",
                "Glucose_500_minimal_media",
                "AMPO_180_minimal_media",
                "BOA_2500_minimal_media",
                "MBOA_2500_minimal_media",
                "DMG_2500_minimal_media",
                "Glucose_2500_minimal_media",
                "Glucose_30000_minimal_media",
                "Media_TSB_MM",
                "Dummy2"),
 "Replicate" = c("NULL", rep("REP2", times = 22), "NULL"), # times = all plates but without the dummy plates
 "Plate" = c("NULL", rep("metabolite_plate", times = 22),  "NULL"), 
 "Media" = c("NULL", rep ("TSB", times = 9), rep ("MM", times =12), "TSB_MM", "NULL"),
 "Chem" = c("NULL", "DMSO_500", "BOA_500", "MBOA_500", "DMG_500", "AMPO_30", "BOA_2500", "MBOA_2500", "DMG_2500", "AMPO_180", "DMSO_2500", "AMPO_30",
            "BOA_500", "MBOA_500", "DMG_500", "Glc_500", "AMPO_180", "BOA_2500", "MBOA_2500", "DMG_2500", "Glc_2500", "Glc_30000", "no", "NULL"))


# Initialize / clear df

# Loop through sheets

for (i in 1:nrow(treatlist1)) {
  tmp <- read_excel("Input/6_Data_Tolerance_Carbon_source_BXs_strains.xlsx", sheet = i, range = "B26:CU68") %>%   # change for duration runs
    dplyr::select(-`T° 600`) %>% # Drop Temperature
    #pivot_longer(names_to = "Well", values_to = "Density") %>%  #Make long
    gather(key = "Well", value = "Density", 2:ncol(.)) %>%
    mutate(Treat = as.character(treatlist1[i,1]), #Add treatment
    Rep = as.character(treatlist1[i,2]),
    Plate = as.character(treatlist1[i,3]),
    Media = as.character(treatlist1[i,4]),
    Chem = as.character(treatlist1[i,5]),
    Well_Plate = interaction(Well, Plate, sep = "_")) #Add Replicate
results <- bind_rows(results, tmp)
}
```

```{r, warning=FALSE, include=FALSE}
# Get times based on difftime
results %<>%
  filter(Treat != "Dummy1" ) %>%
  filter(Treat != "Dummy2") %>%
  filter(Density != "NA") %>% 
  mutate(mins = difftime(Time, Time[1], units = "mins") %>% as.numeric(),
         hrs = difftime(Time, Time[1], units = "hours") %>% as.numeric()) %>% 
  left_join(., Strain_Data, by = "Well_Plate")
```

4. Formatting
Subset experiments
```{r, warning=FALSE, include=FALSE}
results %<>% dplyr::select(-Well.x, -Plate.x, -Time) %>% dplyr::rename(Well = Well.y, Plate = Plate.y) %>%  as.data.frame() 
```



```{r, warning=FALSE, include=FALSE}
results_raw <- results
```

5. Split wells to row and column
For plotting convenience, split well into row (chars) and cols (number)
```{r, warning=FALSE, include=FALSE}
results %<>% mutate(Row = Well %>% str_extract(.,"[A-H]"),
                    Col = Well %>% str_extract(.,"[0-9]+") %>% as.numeric())
```

```{r, warning=FALSE, include=FALSE}
results %<>% mutate(Strain = gsub("_m", "", Strain)) %>%
  mutate(Strain = gsub("SynCom S", "nonSC", Strain)) %>%
  mutate(Strain = gsub("SynCom R", "metSC", Strain))
```

filter and keep only the strains and the media conditions used here
```{r, warning=FALSE, include=FALSE}
results %<>% filter(!Strain %in% c("LPD2", "LBA112", "LRC7.O", "LMD1", "LSP13", "LMX922", "LAC11", "LME3")) %>% 
  filter(Chem %in% c("DMSO_500", "DMSO_2500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500", "Glc_30000"))
```


```{r, warning=FALSE, include=FALSE}
# Make density increase relative to first timepoint
results %>% 
  filter(!Strain %in% c("Ignore","None")) %>%
  filter(hrs == 0) %>% 
  filter(Chem %in% c("DMSO_500", "DMSO_2500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500")) %>% 
  group_by(Rep, Well_Plate, Treat) %>%
  ggplot(aes(y=Density, x = Chem, color = as.factor(Replicate), shape = Media)) + geom_point() +
  facet_wrap(~Strain)+
  labs(y = "OD t0")

# some of the t0 values are verz high. Should probably be removed (e.g. LST17 TSB MBOA500 or LMB2 MM MBOA500 at least one rep.) For LMG1 already from the beginning only very few datapoints. check where they might be removed. 

```


Only look at the TSB data 
```{r, warning=FALSE, include=FALSE}
# Make density increase relative to first timepoint
results %>% 
  filter(Media == "TSB", Replicate %in% c(1,2,3,4,5)) %>% 
  filter(!Strain %in% c("Ignore","None")) %>%
  filter(Chem %in% c("DMSO_500",  "MBOA_500", "MBOA_2500")) %>% 
  mutate(ChemFac = factor(Chem, levels = c("DMSO_500",  "MBOA_500", "MBOA_2500"))) %>% 
  group_by(Rep, Well_Plate, Treat) %>%
  ggplot(aes(y=Density, x = hrs, color = as.factor(Replicate))) + geom_point() +
  facet_wrap(Strain~ChemFac)+
  labs(y = "OD600")+
  theme_bw()

# some of the t0 values are verz high. Should probably be removed (e.g. LST17 TSB MBOA500 or LMB2 MM MBOA500 at #least one rep.) For LMG1 already from the beginning only very few datapoints. check where they might be removed. 
# also based on this graph should remove LBA21 replicate 5 from the analysis
```



Look at the MM data
```{r, warning=FALSE, include=FALSE}
# Make density increase relative to first timepoint
results %>% 
  filter(Media == "MM", Replicate %in% c(1,2,3,4,5)) %>% 
  filter(!Strain %in% c("Ignore","None")) %>%
  filter(Chem %in% c("DMSO_2500",  "MBOA_500", "MBOA_2500",  "Glc_500", "Glc_2500", "Glc_30000")) %>% 
  mutate(ChemFac = factor(Chem, levels = c("DMSO_2500",   "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500", "Glc_30000"))) %>% 
  group_by(Rep, Well_Plate, Treat) %>%
  ggplot(aes(y=Density, x = hrs, color = as.factor(Replicate))) + geom_point(size = 1) +
  facet_wrap(~interaction(ChemFac, Strain), ncol = 6)+
  labs(y = "OD600")+
  theme_bw()

# some of the t0 values are verz high. Should probably be removed (e.g. LST17 TSB MBOA500 or LMB2 MM MBOA500 at #least one rep.) For LMG1 already from the beginning only very few datapoints. check where they might be removed. 
# also based on this graph should remove LBA21 replicate 5 from the analysis
```

for which one is there a 6th replicate? - NBCs
```{r, warning=FALSE, include=FALSE}
# Make density increase relative to first timepoint
results %>% 
filter(Replicate == 6) %>% 
  filter(!Strain %in% c("Ignore","None")) %>%
  filter(Chem %in% c("DMSO_2500",  "MBOA_500", "MBOA_2500",  "Glc_500", "Glc_2500", "Glc_30000")) %>% 
  mutate(ChemFac = factor(Chem, levels = c("DMSO_2500",   "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500", "Glc_30000"))) %>% 
  group_by(Rep, Well_Plate, Treat) %>%
  ggplot(aes(y=Density, x = hrs, color = as.factor(Replicate))) + geom_point(size = 1) +
  facet_wrap(~interaction(ChemFac, Strain), ncol = 6)+
  labs(y = "OD600")+
  theme_bw()

# some of the t0 values are verz high. Should probably be removed (e.g. LST17 TSB MBOA500 or LMB2 MM MBOA500 at #least one rep.) For LMG1 already from the beginning only very few datapoints. check where they might be removed. 
# also based on this graph should remove LBA21 replicate 5 from the analysis
```

```{r, warning=FALSE, include=FALSE}
# Make density increase relative to first timepoint
results %<>%
  filter(!Strain %in% c("Ignore","None")) %>%
  group_by(Rep, Well_Plate, Treat) %>%
  mutate(Density_increase = Density - Density[1]) %>%
  ungroup %>% as.data.frame()
```

```{r, warning=FALSE, include=FALSE}
# write_rds(results, paste0("results_Tolerance_Carbon_source_BXs_strains.rds"))
```

# Growth curves 
Minimal medium with glucose or MBOA as sole carbon source. DMSO concentration is kept constant.
```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE, fig.dim = c(8,8)}
FigS5_growth_curves_mm <- results %>%  
  filter(Media %in% "MM") %>% 
  #filter(Density_increase > 0) %>% 
  filter(Strain %in% c("LST17", "LMX9", "LMX9231", "LMN1", "LBA21", "LMG1", "LMB2", "LMI1x")) %>% 
  mutate(Strain = factor(Strain, levels = c("LST17", "LMX9", "LMX9231", "LMN1", "LBA21", "LMG1", "LMB2", "LMI1x"))) %>% 
  filter(Chem %in% c("DMSO_2500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500")) %>% 
  mutate(Chem = factor(Chem, levels = c("DMSO_2500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500"))) %>% 
  ggplot(aes(x=hrs, y= Density_increase, color = Treat)) +
  geom_line(aes(colour = Chem, linetype = as.factor(Replicate))) +
  scale_colour_manual(values = c("#bebebe","#555ccb","#00008b", "#98b08f","#698161")) +
  theme_bw() +
  theme(strip.background = element_blank())+
  scale_y_continuous(expand = expansion(c(0, 0.1)))+
  facet_wrap(~ Strain, nrow = 2, scales = "free_y") +
  labs(x = "Time [hours]",
       y = expression(DeltaOD[600]), 
       title = "Growth curves minimal media",
       color = "Treatment")
  
FigS5_growth_curves_mm

# ggsave(plot = FigS5_growth_curves_mm, path = "../../all_figures", filename = "FigS5_growth_curves_mm.pdf", width = 30, height = 10, dpi = 300, scale = 1, units = "cm")
# 
# ggsave(plot = FigS5_growth_curves_mm, path = "../../all_figures", filename = "FigS5_growth_curves_mm.svg", width = 30, height = 10, dpi = 300, scale = 1, units = "cm")
```


```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE, fig.dim = c(8,8)}
FigS5_growth_curves_mm_OD <- results %>%  
  filter(Media %in% "MM") %>% 
  #filter(Density_increase > 0) %>% 
  filter(Strain %in% c("LST17", "LMX9", "LMX9231", "LMN1", "LBA21", "LMG1", "LMB2", "LMI1x")) %>% 
  mutate(Strain = factor(Strain, levels = c("LST17", "LMX9", "LMX9231", "LMN1", "LBA21", "LMG1", "LMB2", "LMI1x"))) %>% 
  filter(Chem %in% c("DMSO_2500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500")) %>% 
  mutate(Chem = factor(Chem, levels = c("DMSO_2500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500"))) %>% 
  ggplot(aes(x=hrs, y= Density, color = Treat)) +
  geom_line(aes(colour = Chem, linetype = as.factor(Replicate))) +
  scale_colour_manual(values = c("#bebebe","#555ccb","#00008b", "#98b08f","#698161")) +
  theme_bw() +
  theme(strip.background = element_blank())+
  scale_y_continuous(expand = expansion(c(0, 0.1)))+
  facet_wrap(~ Strain, nrow = 2, scales = "free_y") +
  labs(x = "Time [hours]",
       y = expression(OD[600]), 
       title = "Growth curves minimal media",
       color = "Treatment")
  
FigS5_growth_curves_mm_OD

# ggsave(plot = FigS5_growth_curves_mm, path = "../../all_figures", filename = "FigS5_growth_curves_mm.pdf", width = 30, height = 10, dpi = 300, scale = 1, units = "cm")
# 
# ggsave(plot = FigS5_growth_curves_mm, path = "../../all_figures", filename = "FigS5_growth_curves_mm.svg", width = 30, height = 10, dpi = 300, scale = 1, units = "cm")
```

1/2 TSB supplemented with varying concentration of MBOA. DMSO concentration is kept constant.
```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE, fig.dim = c(8,8)}
FigS2B_growth_curves_TSB <- results %>%  
  filter(Media %in% "TSB") %>% 
  #filter(Density_increase > 0) %>% 
  filter(Strain %in% c("LST17", "LMX9", "LMX9231", "LMN1", "LBA21", "LMG1", "LMB2", "LMI1x")) %>% 
  mutate(Strain = factor(Strain, levels = c("LST17", "LMX9", "LMX9231", "LMN1", "LBA21", "LMG1", "LMB2", "LMI1x"))) %>% 
  filter(Chem %in% c("DMSO_500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500")) %>% 
  mutate(Chem = factor(Chem, levels = c("DMSO_500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500"))) %>% 
  ggplot(aes(x=hrs, y= Density_increase, color = Treat)) +
  geom_line(aes(colour = Chem, linetype = as.factor(Replicate))) +
  scale_colour_manual(values = c("#bebebe","#555ccb","#00008b", "#98b08f","#698161")) +
  theme_bw() +
  theme(strip.background = element_blank())+
  scale_y_continuous(expand = expansion(c(0, 0.1)))+
  facet_wrap(~ Strain, nrow = 2, scales = "free_y") +
  labs(x = "Time [hours]",
       y = expression(DeltaOD[600]), 
       title = "Growth curves complex media",
       color = "Treatment")
  
FigS2B_growth_curves_TSB

# ggsave(plot = FigS2B_growth_curves_TSB, path = "../../all_figures", filename = "FigS2B_growth_curves_tsb.pdf", width = 30, height = 10, dpi = 300, scale = 1, units = "cm")
# 
# ggsave(plot = FigS2B_growth_curves_TSB, path = "../../all_figures", filename = "FigS2B_growth_curves_tsb.svg", width = 30, height = 10, dpi = 300, scale = 1, units = "cm")
```

here with the OD measurements. Note that strictly speaking the mean of the NBCs should be removed. 
```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE, fig.dim = c(8,8)}
FigS2B_growth_curves_TSB_OD <- results %>%  
  filter(Media %in% "TSB") %>% 
  #filter(Density_increase > 0) %>% 
  filter(Strain %in% c("LST17", "LMX9", "LMX9231", "LMN1", "LBA21", "LMG1", "LMB2", "LMI1x")) %>% 
  mutate(Strain = factor(Strain, levels = c("LST17", "LMX9", "LMX9231", "LMN1", "LBA21", "LMG1", "LMB2", "LMI1x"))) %>% 
  filter(Chem %in% c("DMSO_500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500")) %>% 
  mutate(Chem = factor(Chem, levels = c("DMSO_500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500"))) %>% 
  ggplot(aes(x=hrs, y= Density, color = Treat)) +
  geom_line(aes(colour = Chem, linetype = as.factor(Replicate))) +
  scale_colour_manual(values = c("#bebebe","#555ccb","#00008b", "#98b08f","#698161")) +
  theme_bw() +
  theme(strip.background = element_blank())+
  scale_y_continuous(expand = expansion(c(0.05, 0.1)))+
  facet_wrap(~ Strain, nrow = 2, scales = "free_y") +
  labs(x = "Time [hours]",
       y = expression(OD[600]), 
       title = "Growth curves complex media",
       color = "Treatment")
  
FigS2B_growth_curves_TSB_OD

ggsave(plot = FigS2B_growth_curves_TSB_OD, path = "Output", filename = "FigS2B_growth_curves_tsb_OD.pdf", width = 30, height = 10, dpi = 300, scale = 1, units = "cm", create.dir = T)
# 
# ggsave(plot = FigS2B_growth_curves_TSB, path = "../../all_figures", filename = "FigS2B_growth_curves_tsb.svg", width = 30, height = 10, dpi = 300, scale = 1, units = "cm")
```

# AUC
To quantify the total bacterial growth over time, we calculate the total area under the curve. This is done with the function "auc()". Before that, negative values for density increase were filtered out (i.e., strains or replicates that didn't grow). For comparison between treatments, the total AUC (calculated using density increase) and AUC_raw (calculated using raw density) is normalized with the AUC of the strain grown in the control treatment (no chemicals added, just normal growth media with DMSO).

```{r, warning=FALSE, include=FALSE}
results_AUC <- results %>% 
  unique() %>% 
  filter(Density_increase > 0) %>% # removes 'negative' growth curves
  group_by(Treat, Rep, Media, Chem, Strain, Well, Replicate, Plate) %>% 
  dplyr::summarise(AUC = auc(hrs, Density_increase), AUC_raw = auc(hrs, Density)) %>%
  ungroup %>% 
  mutate(AUC_pos = abs(AUC)) %>% 
  mutate(Well_Strain_Replicate_Rep_Chem_Media = paste(Well, Strain, Replicate, Rep, Chem, Media)) %>% 
  arrange(desc(Chem))  %>% # this a super important step to normalize with the growth in Conc = 0 (Conc has to be a numeric, see above)
  #Split by Rep
  base::split(., .$Well_Strain_Replicate_Rep_Chem_Media) %>% #Make each strain / rep combination its own data.frane
  map_dfr(~ 
  mutate(.x, AUC_norm = AUC_pos / AUC_pos[length(AUC_pos)])) %>% 
  as.data.frame()

Strain_Data_2 <- Strain_Data %>% 
  mutate(Strain = gsub("_m", "", Strain)) %>% 
  dplyr::select(Strain, Phylum, Class, Order, Family, Genus) %>% 
  unique() %>% as.data.frame()

results_AUC <- left_join(results_AUC, Strain_Data_2, by = "Strain")
```

```{r, warning=FALSE, include=FALSE}
results_AUC %<>% filter(!Strain %in% c("LPD2", "LBA112", "LRC7.O", "LMD1", "LSP13", "LMX922", "LAC11", "LME3"))
results_AUC$Strain %>% unique()
```

```{r, warning=FALSE, include=FALSE}
results_AUC %<>% 
mutate(Strain = factor(Strain, levels = c("LST17", "LMX9", "LMX9231", "LMN1", "LBA21", "LMG1", "LMB2", "LMI1x", "nonSC", "metSC", "NBC"))) %>% 
  mutate(col_strain = case_when(Strain %in% "LBA21" ~ "#cab2d6",
                                Strain %in% "LMN1" ~ "#1f78b4",
                                Strain %in% "LMX9231" ~ "#a6cee3",
                                Strain %in% "LMX9" ~ "#33a02c",
                                Strain %in% "LST17" ~ "#b2df8a",
                                Strain %in% "LMG1" ~ "#6a3d9a",
                                Strain %in% "LMI1x" ~ "#fdbf6f",
                                Strain %in% "LMB2" ~ "#e31a1c",
                                Strain %in% "nonSC" ~ "#fdbf6f",
                                Strain %in% "metSC" ~ "#e31a1c",
                                Strain %in% "NBC" ~ "gray"))

temp <- data.frame(results_AUC$Strain, results_AUC$col_strain)
temp <- plyr::ddply(temp, .variables="results_AUC.Strain", .fun=unique)   #library(plyr)
level_cols_Strain <- as.character(temp[,2])
names(level_cols_Strain) <- temp[,1]
```

```{r, message=FALSE, echo=FALSE, error=FALSE, warning=FALSE}
tolerance_groups <- results_AUC %>% 
  filter(Media %in% "TSB") %>% 
  filter(Strain %in% c("LBA21", "LMN1", "LMX9231", "LMX9", "LMG1", "LST17", "LMI1x", "LMB2")) %>% 
  filter(Chem %in% c("DMSO_500", "MBOA_500", "MBOA_2500")) %>% 
  mutate(Chem = factor(Chem, levels = c("DMSO_500", "MBOA_500", "MBOA_2500"))) %>% 
  dplyr::select(Strain, Chem, AUC, Replicate) %>% 
  pivot_wider(names_from = Chem, values_from = AUC) %>% 
  filter(!DMSO_500 %in% NA) %>% 
  filter(!MBOA_2500 %in% NA) %>% 
  filter(!MBOA_500 %in% NA) %>% 
  group_by(Strain) %>% 
  dplyr::summarize(DMSO_500_mean = mean(DMSO_500),
                   MBOA_500_mean = mean(MBOA_500),
                   MBOA_2500_mean = mean(MBOA_2500)) %>% 
  mutate(Relative_growth_2500 = (MBOA_2500_mean/DMSO_500_mean) * 100) %>% 
  mutate(Tolerance_group = dplyr::case_when(between(Relative_growth_2500, 0, 25) ~ "susceptible",
                                            between(Relative_growth_2500, 25, 50) ~ "intermediate",
                                            between(Relative_growth_2500, 50, 100) ~ "tolerant"))


tolerance_groups %>% dplyr::select(Strain, Tolerance_group, Relative_growth_2500) %>% knitr::kable(col.names = c("Strain", "Tolerance group", "Relative growth high MBOA"))
```

```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE, fig.dim = c(8,8)}
Fig3_TSB_SynCom_MBOA_AUC_treat <- results_AUC %>% 
  filter(Media %in% "TSB") %>% 
  filter(Strain %in% c("nonSC", "metSC")) %>% 
  mutate(Strain = factor(Strain, levels = c("nonSC", "metSC"))) %>%
  filter(Chem %in% c("DMSO_500", "MBOA_500", "MBOA_2500")) %>% 
  mutate(Chem = factor(Chem, levels = c("DMSO_500", "MBOA_500", "MBOA_2500"))) %>% 
  ggplot(aes(x= Strain, y= AUC)) +
  geom_bar(aes(fill = Strain), alpha = 0.5, stat = "summary", position = "dodge", show.legend = FALSE) +
  geom_quasirandom(aes(fill = Strain), shape = 21, alpha = 0.7,  width = 0.3, show.legend = FALSE)+
  geom_errorbar(stat = "summary", width=0.2) +
  stat_compare_means(label = "p.signif", method = "t.test", ref.group = "nonSC", paired = TRUE, 
                     method.args = list(p.adjust.methods = "bonferroni", alternative = "greater", var.equal = FALSE),
                     symnum.args = symnum.args, hide.ns = FALSE, size = 4, label.y = 75) +
  theme_classic() +
  scale_fill_manual(values = c("#fdbf6f", "#e31a1c")) +
  scale_y_continuous(expand = expansion(c(0, 0.1)))+
  facet_wrap(~ Chem, nrow = 1, labeller = as_labeller(c(DMSO_500 = "DMSO", MBOA_500 = "MBOA 500 µM", MBOA_2500 = "MBOA 2500 µM"))) +
  labs(y = "Bacterial growth [AUC]",
        x = NULL,
       title = "growth in complex medium",
       fill = " ")

Fig3_TSB_SynCom_MBOA_AUC_treat

ggsave(plot = Fig3_TSB_SynCom_MBOA_AUC_treat, path = "Output", filename = "Fig3_TSB_SynCom_MBOA_AUC_treat.pdf", width = 8.8, height = 8, dpi = 300, scale = 1, units = "cm")

ggsave(plot = Fig3_TSB_SynCom_MBOA_AUC_treat, path = "Output", filename = "Fig3_TSB_SynCom_MBOA_AUC_treat.svg", width = 8.8, height = 8, dpi = 300, scale = 1, units = "cm")
```

```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE, fig.dim = c(8,8)}
FigS2A_TSB_Strain_MBOA_AUC <- results_AUC %>% 
  filter(Media %in% "TSB") %>% 
  filter(Strain %in% c("LBA21", "LMN1", "LMX9231", "LMX9", "LMG1", "LST17", "LMI1x", "LMB2")) %>% 
  filter(Chem %in% c("DMSO_500", "MBOA_500", "MBOA_2500")) %>% 
  mutate(Chem = factor(Chem, levels = c("DMSO_500", "MBOA_500", "MBOA_2500"))) %>% 
  ggplot(aes(x= Chem, y= AUC)) +
  geom_bar(aes(fill = Chem), alpha = 0.5, stat = "summary", position = "dodge", show.legend = FALSE) +
  geom_quasirandom(aes(fill = Chem), shape = 21, alpha = 0.7,  width = 0.3, show.legend = FALSE)+
  geom_errorbar(stat = "summary", width=0.2) +
  stat_compare_means(paired = FALSE, label = "p.signif", 
                     method ="t.test", ref.group = "DMSO_500", size = 3, label.y = 70, hide.ns = TRUE, 
                     method.args = list(p.adjust.methods = "bonferroni", var.equal = FALSE),
                     symnum.args = symnum.args) + #one sided
  theme_classic() +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.25))+
  scale_fill_manual(values = c("#bebebe","#555ccb","#00008b")) + 
  scale_x_discrete(labels=c("DMSO", "MBOA 500 µM", "MBOA 2500 µM"))+
  scale_y_continuous(expand = expansion(c(0, 0.1)))+
  facet_wrap(~ Strain, nrow = 1) +
  labs(y = "Bacterial growth [AUC]",
        x = NULL,
       title = "growth in complex medium",
       fill = "Chemical")

FigS2A_TSB_Strain_MBOA_AUC

ggsave(plot = FigS2A_TSB_Strain_MBOA_AUC, path = "Output", filename = "FigS2A_TSB_Strain_MBOA_AUC.pdf", width = 10, height = 8, dpi = 300, scale = 1, units = "cm")

ggsave(plot = FigS2A_TSB_Strain_MBOA_AUC, path = "Output", filename = "FigS2A_TSB_Strain_MBOA_AUC.svg", width = 10, height = 8, dpi = 300, scale = 1, units = "cm")
```


```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE, fig.dim = c(8,8)}
Fig3_MM_SynCom_MBOA_AUC_treat_no30000 <- results_AUC %>% 
  filter(Media %in% "MM") %>% 
  filter(Strain %in% c("nonSC", "metSC")) %>% 
  mutate(Strain = factor(Strain, levels = c("nonSC", "metSC"))) %>%
  filter(Chem %in% c("DMSO_2500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500")) %>% 
  mutate(Chem = factor(Chem, levels = c("DMSO_2500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500"))) %>% 
  ggplot(aes(x= Strain, y= AUC)) +
  geom_bar(aes(fill = Strain), alpha = 0.5, stat = "summary", position = "dodge", show.legend = FALSE) +
  geom_quasirandom(aes(fill = Strain), shape = 21, alpha = 0.7,  width = 0.3, show.legend = FALSE)+
  geom_errorbar(stat = "summary", width=0.2) +
  stat_compare_means(label = "p.signif", method = "t.test", ref.group = "nonSC", 
                     method.args = list(p.adjust.methods = "bonferroni", alternative = "greater", var.equal = FALSE),
                     symnum.args = symnum.args, hide.ns = TRUE, size = 4, label.y = 25) +
  theme_classic() +
  theme(strip.background = element_blank(), axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.25))+
  scale_fill_manual(values = c("#fdbf6f", "#e31a1c")) +
  scale_y_continuous(expand = expansion(c(0, 0.1)))+
  facet_wrap(~ Chem, nrow = 1, labeller = as_labeller(c(DMSO_2500 = "DMSO", MBOA_500 = "MBOA 500 µM", 
                                                        MBOA_2500 = "MBOA 2500 µM", Glc_500 = "Glc 500 µM", 
                                                        Glc_2500 = "Glc 2500 µM"))) +
  labs(y = "Bacterial growth [AUC]",
       x = NULL,
       title = "growth in minimal medium",
       fill = " ")

Fig3_MM_SynCom_MBOA_AUC_treat_no30000

ggsave(plot = Fig3_MM_SynCom_MBOA_AUC_treat_no30000, path = "Output", filename = "Fig3_MM_SynCom_MBOA_AUC_treat_no30000.pdf", width = 8, height = 8, dpi = 300, scale = 1, units = "cm")

ggsave(plot = Fig3_MM_SynCom_MBOA_AUC_treat_no30000, path = "Output", filename = "Fig3_MM_SynCom_MBOA_AUC_treat_no30000.svg", width = 8, height = 8, dpi = 300, scale = 1, units = "cm")
```

```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE, fig.dim = c(8,8)}
FigS5A_MM_Strain_MBOA_AUC_no30000 <- results_AUC %>% 
  filter(Media %in% "MM") %>% 
  # filter(Strain %in% c("LMG1")) %>% 
  filter(Strain %in% c("LBA21", "LMN1", "LMX9231", "LMX9", "LMG1", "LST17", "LMI1x", "LMB2")) %>% 
  filter(Chem %in% c("DMSO_2500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500")) %>% 
  mutate(Chem = factor(Chem, levels = c("DMSO_2500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500"))) %>% 
  ggplot(aes(x= Chem, y= AUC)) +
  geom_bar(aes(fill = Chem), alpha = 0.5, stat = "summary", position = "dodge", show.legend = FALSE) +
  geom_quasirandom(aes(fill = Chem), shape = 21, alpha = 0.7,  width = 0.3, show.legend = FALSE)+
 stat_compare_means(method = "t.test", paired = TRUE,
                     ref.group = "DMSO_2500",
                     method.args = list(p.adjust.methods = "bonferroni", alternative = "greater", var.equal = FALSE),
                    label = "p.signif", size = 3, label.y = 45, hide.ns = TRUE, symnum.args = symnum.args) +
  geom_errorbar(stat = "summary", width=0.2) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.25), strip.background = element_blank())+
  scale_fill_manual(values = c("#bebebe","#555ccb","#00008b", "#98b08f","#698161")) + 
  scale_y_continuous(expand = expansion(c(0, 0.1)))+
  scale_x_discrete(labels=c("DMSO", "MBOA 500 µM", "MBOA 2500 µM", "Glc 500 µM", "Glc 2500 µM"))+
  facet_wrap(~ Strain, nrow = 1) +
  labs(y = "Bacterial growth [AUC]",
        x = NULL,
       title = "growth in minimal medium",
       fill = "Chemical")

FigS5A_MM_Strain_MBOA_AUC_no30000

ggsave(plot = FigS5A_MM_Strain_MBOA_AUC_no30000, path = "Output", filename = "FigS5A_MM_Strain_MBOA_AUC_no30000.pdf", width = 18, height = 8, dpi = 300, scale = 1, units = "cm")

ggsave(plot = FigS5A_MM_Strain_MBOA_AUC_no30000, path = "Output", filename = "FigS5A_MM_Strain_MBOA_AUC_no30000.svg", width = 18, height = 8, dpi = 300, scale = 1, units = "cm")
```

```{r, echo=F, message=F, warning=F}
results_AUC_selected_LMG1 <- results_AUC %>%  filter(Media %in% "MM") %>% 
  filter(Strain %in% c("LMG1")) %>% 
  filter(Chem %in% c("DMSO_2500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500"))

results_AUC_selected <- results_AUC %>%  filter(Media %in% "MM") %>% 
  filter(Strain %in% c("LBA21", "LMN1", "LMX9231", "LMX9", "LMG1", "LST17", "LMI1x", "LMB2")) %>% 
  filter(Chem %in% c("DMSO_2500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500")) %>% 
  group_by(Strain) 
  
# t.test(y = results_AUC_selected$AUC, x = results_AUC_selected$Chem)
```

```{r, warning=FALSE, include=FALSE}
res <- compare_means(AUC ~ Chem, 
                     data = results_AUC_selected_LMG1, 
                     method = "t.test", 
                     p.adjust.method = "holm",
                     var.equal = FALSE,
                     method.args = list(alternative = "greater"))

results_AUC %>%  filter(Media %in% "MM") %>% 
  filter(Strain %in% c("LBA21", "LMN1", "LMX9231", "LMX9", "LMG1", "LST17", "LMI1x", "LMB2")) %>% 
  filter(Chem %in% c("DMSO_2500", "MBOA_500", "MBOA_2500", "Glc_500", "Glc_2500")) %>% 
  group_by(Strain) %>% compare_means(AUC ~ Chem, 
                     data = ., 
                     method = "t.test", 
                     ref.group = "DMSO_2500",
                     group.by = "Strain",
                     p.adjust.method = "holm",
                     var.equal = FALSE, 
                     method.args = list(alternative = "greater"))

```

# Tolerance index
```{r, warning=FALSE, include=FALSE}
results_AUC_MBOA_TSB <- results %>% 
  unique() %>% 
  filter(Chem %in% c("DMSO_500", "MBOA_500", "MBOA_2500")) %>% 
  filter(Media %in% "TSB") %>% 
  filter(Density_increase > 0) %>% # removes 'negative' growth curves
  mutate(Conc = case_when(Chem %in% "MBOA_2500" ~ "2500",
                          Chem %in% "MBOA_500" ~ "500",
                          Chem %in% "DMSO_500" ~ "0")) %>% 
  mutate(Conc = as.numeric(Conc)) %>% 
  group_by(Treat, Rep, Media, Chem, Conc, Strain, Well, Replicate, Plate) %>% 
  dplyr::summarise(AUC = auc(hrs, Density_increase), AUC_raw = auc(hrs, Density)) %>%
  ungroup %>% 
  mutate(AUC_pos = abs(AUC)) %>% 
  mutate(Well_Strain_Replicate_Rep = paste(Well, Strain, Replicate, Rep)) %>% 
  arrange(desc(Conc))  %>% # this a super important step to normalize with the growth in Conc = 0 (Conc has to be a numeric, see above)
  #Split by Rep
  base::split(., .$Well_Strain_Replicate_Rep) %>% #Make each strain / rep combination its own data.frane
  map_dfr(~ 
  mutate(.x, AUC_norm = AUC_pos / AUC_pos[length(AUC_pos)])) %>% 
  as.data.frame()

results_AUC_MBOA_TSB_all <- left_join(results %>% dplyr::select(Well, Phylum, Class, Order, Family, Genus, ZOTU, Morphology_MBOA) %>% unique, results_AUC_MBOA_TSB, by = "Well")

Strain_Data_2 <- Strain_Data %>% 
  mutate(Strain = gsub("_m", "", Strain)) %>% 
  dplyr::select(Well, Phylum, Class, Order, Family, Genus) %>% 
  unique() %>% as.data.frame()

results_AUC_MBOA_TSB_meta <- left_join(results_AUC_MBOA_TSB, Strain_Data_2, by = "Well")
```



```{r, warning=FALSE, include=FALSE, echo=F}
AUC_tolind_MBOA <- results_AUC_MBOA_TSB %>% 
  # results_AUC_MBOA_TSB_meta %>% 
 # filter(!Strain %in% c("metSC", "nonSC")) %>% 
  filter(AUC_norm < 1.5) %>% 
  filter(!Strain %in% c("no", NA)) %>% 
  group_by(Strain, Replicate) %>% 
  na.omit() %>% 
  unique() %>% 
  mutate(AUC_max = paste("1")) %>%
  dplyr::summarize(TI = auc(Conc, AUC_norm), 
            TI_raw = auc(Conc, AUC_raw),
            TI_max = auc(Conc, AUC_max)) %>% 
  mutate(TI_norm = TI / TI_max)

AUC_tolind_MBOA <- left_join(AUC_tolind_MBOA %>% as.data.frame(), Strain_Data %>% as.data.frame() %>% dplyr::select(Strain, Phylum, Family, Genus), by = "Strain") %>% unique()

## Save table with AUC
# write_rds(AUC_tolind_MBOA, paste0("Output/AUC_tolind_MBOA.rds"))
```

Check data 
```{r, warning=FALSE, include=FALSE}
results_AUC_MBOA_TSB %>% 
  mutate(Replicate =as.factor(Replicate)) %>% 
   mutate(Conc =as.factor(Conc)) %>% 
  filter(Strain %in% c("LST17", "LMX9", "LMX9231", "LMN1", "LBA21", "LMG1", "LMB2")) %>% 
  ggplot(aes(x = Conc, y = AUC_norm)) +
  geom_point(aes(colour = Replicate))+
  facet_wrap(~Strain, scales = "free")
  
```


```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE, fig.dim = c(8,8)}
FigS6TolIndex_metSC <- AUC_tolind_MBOA %>% 
  filter(Strain %in% c("LST17", "LMX9", "LMX9231", "LMN1", "LBA21", "LMG1", "LMB2")) %>% 
  mutate(Strain = factor(Strain, levels = rev(c("LST17", "LMX9", "LMX9231", "LMN1", "LBA21", "LMG1", "LMB2")))) %>% 
  ggplot(aes(x = Strain, y = TI_norm)) +
  geom_bar(aes(fill = Strain), stat = "summary") +
  theme_bw()+
  scale_y_continuous(expand = expansion(c(0, 0.1)))+
  scale_fill_manual(values = level_cols_Strain)+
  coord_flip()

FigS6TolIndex_metSC

ggsave(plot = FigS6TolIndex_metSC, path = "Output", filename = "FigS6TolIndex_metSC.pdf", width = 8, height = 6, dpi = 300, scale = 1, units = "cm")

ggsave(plot = FigS6TolIndex_metSC, path = "Output", filename = "FigS6TolIndex_metSC.svg", width = 8, height = 6, dpi = 300, scale = 1, units = "cm")
```

```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE, fig.dim = c(8,8)}
FigS6TolIndex_nonSC <- AUC_tolind_MBOA %>% 
  filter(Strain %in% c("LST17", "LMX9", "LMX9231", "LMN1", "LBA21", "LMG1", "LMI1x")) %>% 
  mutate(Strain = factor(Strain, levels = rev(c("LST17", "LMX9", "LMX9231", "LMN1", "LBA21", "LMG1", "LMI1x")))) %>% 
  ggplot(aes(x = Strain, y = TI_norm)) +
  geom_bar(aes(fill = Strain), stat = "summary") +
  theme_bw()+
  scale_y_continuous(expand = expansion(c(0, 0.1)))+
  scale_fill_manual(values = level_cols_Strain)+
  coord_flip()

FigS6TolIndex_nonSC

ggsave(plot = FigS6TolIndex_nonSC, path = "Output", filename = "FigS6TolIndex_nonSC.pdf", width = 8, height = 6, dpi = 300, scale = 1, units = "cm")

ggsave(plot = FigS6TolIndex_nonSC, path = "Output", filename = "FigS6TolIndex_nonSC.svg", width = 8, height = 6, dpi = 300, scale = 1, units = "cm")
```

```{r, warning=FALSE, include=FALSE}
sessionInfo()
```

