---
title: "Localization of AMP in LMB2 cultures"
subtitle: "Thoenen et al. BX SynComs"
author: "Christine Pestalozzi"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,include=FALSE}
rm(list=ls())
```

```{r,include=FALSE}
# install.packages("dplyr") 
# install.packages("magrittr") # for the %>% function
# install.packages("ggplot2") # plots
# install.packages("readxl") # to read excels
# install.packages("stringr")
# install.packages("MESS") # for auc function
# install.packages("purrr")
# install.packages("multcomp")
# install.packages("emmeans")
# install.packages("ggpubr")
# install.packages("forcats")
# install.packages("readr")
# install.packages("ggpmisc")
# install.packages("pander")
```

```{r,include=FALSE}
library("tidyverse")
library("magrittr")
library("ggpubr")

```


The observation that AMPO is formed in cultures of LMB2 supplemented with MBOA and the predicted activity of BxdA, clearly indicate that AMP is formed as an intermediate. Since in a SynCom HMPAA is formed, AMP must be available to the SynCom strains. 
Here, we tested whether AMP can be detected in the supernatant of LMB2 cultures grown in 0.5x TSB+MBOA.


Metabolite samples were prepared as described before (Thoenen et al 2024, Nat Commun). 
Samples are quantified based on area under the growth curve. (No standard curves available by mistake)

# Is AMP present in supernatant of LMB2 cultured in presence of MBOA?
This data corresponds to Experiment "25CMP18", "Objective1".
LMB2 was cultured in 20 mL 1/2 TSB supplemented with 500 uM MBOA for 5 h at 28Â°C, 180 rpm. As a control LMB2 cultured with DMSO and was used, as well as cultures inoculated with 1/2 TSB instead of LMB2. Three independent cultures were used for each (separate pre-cultures). Different fractions of samples (i.e. supernatant and pellet) were only collected for LMB2 grown in presence of MBOA.
At 5 h, samples for metabolite measurements were taken from LMB2 cultures grown with MBOA. For supernatant fraction, 1 mL of sample was pelleted in a 1.5 mL tube at 3200xg for 10 min. The supernatant was transferred to a fresh eppendorf tube and a metabolite sample taken (SN). The pellet was then washed twice with 1/2 TSB containing neither DMSO nor MBOA and resuspended in 1/2 TSB before a metabolite sample was taken (P).
As a control, metabolite samples of the whole culture (C) were taken directly. 
For the NBC controls, only culture samples were taken. 
Note: that the DMSO control samples were pooled prior to filtering during dilution of the metabolite samples for MS analysis, resulting in 1 replicate. For the MBOA samples, triplicate samples were further processed.



Read in the metadata 
```{r read in metadata, include=FALSE}
meta <- read.delim(file = "Input/20250623_Samples_Berne_Metabolization_Pestalozzi_corr.txt", header = T) 
meta %<>% select(1:9) # note that some columns only contained information for reading of the data. These are not kept here


```


Read in the metabolite data (keep only data for compounds that were detected in at least one sample)
```{r read in MS data, include=FALSE}
# First read in the BXs usually measured with standard
# 1. Read in the full file as lines
lines <- readLines("Input/20250623_PM_CP_25CMP18_MBOA.txt") #Bxs

# 2. Find compound header lines (e.g., "Compound 1: Name")
compound_header_indices <- grep("^Compound \\d+: ", lines)

# 3. Add an artificial end index to loop over last compound
compound_header_indices <- c(compound_header_indices, length(lines) + 1)

# 4. For each compound, extract the relevant chunk and parse
compound_tables <- map2_df(
  compound_header_indices[-length(compound_header_indices)],
  compound_header_indices[-1] - 1,
  function(start, end) {
    # Extract lines for this compound
    chunk <- lines[start:end]
    
    # Extract compound name from first line
    compound_name <- str_match(chunk[1], "^Compound \\d+:\\s*(.+)$")[,2]
    
    # Skip the first line (compound name) and blank line
    table_lines <- chunk[-c(1,2)]
    
    # Read as a CSV from text with tab delimiter
    table <- read_tsv(paste(table_lines, collapse = "\n"), show_col_types = FALSE)
    
    # Add compound name column and select desired columns
    table <- table %>%
      mutate(Compound = compound_name) %>%  
      dplyr::select(Sample.Nr = '#', Name, Type, Area, Detection.Flags = `Detection Flags`, Compound)
    
    return(table)
  }
)

# add additionally the data for AMP and HMPAA
AMP_data <- read.delim("Input/20250623_PM_CP_25CMP18_HMPAA.txt", skip = 6, nrows = 87) %>% mutate(Compound = "AMP") %>% dplyr::select(Sample.Nr =X, Name, Type, Area, Detection.Flags, Compound)

HMPAA_data <- read.delim("Input/20250623_PM_CP_25CMP18_HMPAA.txt", skip = 97) %>% mutate(Compound = "HMPAA") %>% dplyr::select(Sample.Nr =X, Name, Type, Area, Detection.Flags, Compound)


compound_tables <- rbind(compound_tables, AMP_data, HMPAA_data)
# get a list of detected compounds and make results table "met" containing only these
compound_detected <- compound_tables %>% group_by(Compound) %>% dplyr::filter(!(is.na(Area))) %>% summarise(n = n()) %>% pull(Compound)
met <- compound_tables %>% dplyr::filter(Compound %in% compound_detected)

# View(met)

# clean up environment
rm(compound_tables, compound_header_indices, lines, AMP_data, HMPAA_data)

``` 

Combine the metadata and metabolite data
```{r annotate data, include=FALSE}
data <- met %>% 
  select(Sample.Nr,  Name, Type, Area, Detection.Flags, Compound) %>% 
  left_join(meta %>% rename(Fraction = Type), by = c("Sample.Nr" = "Number.HPLC.Vial_corr")) %>% 
  mutate(Compound = factor(Compound, levels = c("MBOA", "AMP", "AMPO", "AAMPO", "HMPAA"))) #%>% 
  # mutate() # here multiply the samples required by 3

rm(met, meta)
```

Colors for plotting etc
```{r color vectors, include=FALSE}
Compound_colors <- setNames(c("darkblue", "maroon", "darkred", "firebrick1", "gold2"), nm = c("MBOA", "AMP", "AMPO", "AAMPO", "HMPAA"))
```




```{r combine data and plot for answering question1, echo=F, message=F, warning=F}
data.AMPloc <- data %>% 
  dplyr::filter(Exp == "25CMP18" & TP == "5h") %>% 
  mutate(Compound = factor(Compound, levels = c("MBOA", "AMP", "AMPO", "AAMPO", "HMPAA"))) %>% 
  mutate(Treatment = factor(Treatment, levels = c("NBC", "LMB2", "LMB2_SN", "LMB2_P")))


# need to add stats
Localization_AMP <- data.AMPloc %>% 
  dplyr::filter(Compound != "AAMPO", Compound != "HMPAA") %>% 
  dplyr::filter(MBOA == "TSB_MBOA") %>%
  ggplot(aes(x = Treatment, y = Area, group = Compound)) +
  geom_bar(aes(fill = Compound), stat="summary", position="dodge", size = 2, show.legend = TRUE) +
  # ggbeeswarm::geom_quasirandom(aes(fill = Compound), shape = 21,   width = 0.3, show.legend = FALSE)+
  ggbeeswarm::geom_quasirandom( width = 0.3, show.legend = FALSE)+
  geom_errorbar(stat = "summary", width=0.2) +
  theme_classic() +
  scale_y_continuous(expand = expansion(mult = c(0, .1)), breaks = c(0, 10000, 20000, 30000))+
  scale_x_discrete(labels=c("NBC", "C", "S","P"))+
  scale_fill_manual(values = Compound_colors) +
  theme_classic() +
  facet_wrap(~Compound, nrow = 1)+
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0, colour = "black"), 
        axis.text.y = element_text(colour = "black"), strip.background = element_blank()) +
  labs(title = "AMP and AMPO are present in the supernatant",
       x = "",
       y = "concentration [Area]")
# Localization_AMP

# Statistic: add Welch-s t-test statistics for the ones that contain sufficient detected samples.
data.stats <-  Localization_AMP$data %>% group_by(Compound, Treatment) %>% filter(sum(!is.na(Area)) >=2) %>% ungroup() # need at least two Area values for statistics
t.test <- compare_means(Area ~ Treatment, data = data.stats, group.by = "Compound", method = "t.test", p.adjust.method = "bonferroni") %>% 
  mutate(p.signif.sign = ifelse(p.adj <= 0.05, "*", "ns"))

# get y position
y_pos <- data.stats %>% group_by(Compound) %>% summarise(y.position = max(Area, na.rm = T)*1.01)
t.test.ypos <- t.test  %>%  left_join(y_pos) %>% ungroup() %>%  filter(p.signif.sign != "ns") %>% group_by(Compound) %>%  mutate(y.position.plot = y.position + row_number()*2000) %>% ungroup()

Final_plot_stats <- Localization_AMP +
  stat_pvalue_manual(t.test.ypos, "y.position.plot", label = "p.signif.sign")
Final_plot_stats


#ggsave(plot = Localization_AMP, filename = "Localization_AMP_LMB2_Area.pdf",width = 13.2, height = 8, dpi = 300, scale = 1, units = "cm")
# ggsave(plot = Localization_AMP, filename = "Output/Localization_AMP_LMB2_Area.pdf",width = 16, height = 8, dpi = 300, scale = 1, units = "cm")
# ggsave(plot = Localization_AMP, filename = "Output/Localization_AMP_LMB2_Area.png",width = 16, height = 8, dpi = 300, scale = 1, units = "cm")
# 

ggsave(plot = Final_plot_stats, filename = "Output/Final_plot_stats.pdf",width = 16, height = 8, dpi = 300, scale = 1, units = "cm")
ggsave(plot = Final_plot_stats, filename = "Output/Final_plot_stats.png",width = 16, height = 8, dpi = 300, scale = 1, units = "cm")

```


```{r}
sessionInfo()
```


