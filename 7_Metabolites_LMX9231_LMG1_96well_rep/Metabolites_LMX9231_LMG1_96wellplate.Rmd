---
title: "Degradation of MBOA by LMG1, LMX9231 and LMB2 in 96-well plates"
subtitle: "Thoenen et al. BX SynComs"
author: "Christine Pestalozzi"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,include=FALSE}
rm(list=ls())
```

```{r,include=FALSE}
# install.packages("dplyr") 
# install.packages("magrittr") # for the %>% function
# install.packages("ggplot2") # plots
# install.packages("readxl") # to read excels
# install.packages("stringr")
# install.packages("MESS") # for auc function
# install.packages("purrr")
# install.packages("multcomp")
# install.packages("emmeans")
# install.packages("ggpubr")
# install.packages("forcats")
# install.packages("readr")
# install.packages("ggpmisc")
# install.packages("pander")
```

```{r,include=FALSE}
library("tidyverse")
library("magrittr")
library("ggpubr")
library("multcompView")

```


# Degradataion of MBOA by LMB2, LMX9231 and LMG1 in 96-well plates

50% TSB supplemented with 500 µM MBOA. Note that the MBOA here already had a slight oranigsh color (the powder). Not SIGMA! 
2 min shaking prior to measurement, but since only 4 plates, get many measurements. 
Unlike in other experiments, here the OD was measured with lid to reduce evaporation. 


Metabolite samples were prepared as described before (Thoenen et al 2024, Nat Commun) 
Metabolites are quantified relative to each other based on integrated peak areas.

Read in the metadata 
```{r read in metadata, include=FALSE}
meta <- read.delim(file = "Input/20250623_Samples_Berne_Metabolization_Pestalozzi_corr.txt", header = T) 
meta %<>% select(1:9) # note that some columns only contained information for reading of the data. These are not kept here


```


Read in the metabolite data (keep only data for compounds that were detected in at least one sample)
```{r read in MS data, include=FALSE}
# First read in the BXs usually measured with standard
# 1. Read in the full file as lines
lines <- readLines("Input/20250623_PM_CP_25CMP18_MBOA.txt") #Bxs

# 2. Find compound header lines (e.g., "Compound 1: Name")
compound_header_indices <- grep("^Compound \\d+: ", lines)

# 3. Add an artificial end index to loop over last compound
compound_header_indices <- c(compound_header_indices, length(lines) + 1)

# 4. For each compound, extract the relevant chunk and parse
compound_tables <- map2_df(
  compound_header_indices[-length(compound_header_indices)],
  compound_header_indices[-1] - 1,
  function(start, end) {
    # Extract lines for this compound
    chunk <- lines[start:end]
    
    # Extract compound name from first line
    compound_name <- str_match(chunk[1], "^Compound \\d+:\\s*(.+)$")[,2]
    
    # Skip the first line (compound name) and blank line
    table_lines <- chunk[-c(1,2)]
    
    # Read as a CSV from text with tab delimiter
    table <- read_tsv(paste(table_lines, collapse = "\n"), show_col_types = FALSE)
    
    # Add compound name column and select desired columns
    table <- table %>%
      mutate(Compound = compound_name) %>%  
      dplyr::select(Sample.Nr = '#', Name, Type, Area, Detection.Flags = `Detection Flags`, Compound)
    
    return(table)
  }
)

# add additionally the data for AMP and HMPAA
AMP_data <- read.delim("Input/20250623_PM_CP_25CMP18_HMPAA.txt", skip = 6, nrows = 87) %>% mutate(Compound = "AMP") %>% dplyr::select(Sample.Nr =X, Name, Type, Area, Detection.Flags, Compound)

HMPAA_data <- read.delim("Input/20250623_PM_CP_25CMP18_HMPAA.txt", skip = 97) %>% mutate(Compound = "HMPAA") %>% dplyr::select(Sample.Nr =X, Name, Type, Area, Detection.Flags, Compound)


compound_tables <- rbind(compound_tables, AMP_data, HMPAA_data)
# get a list of detected compounds and make results table "met" containing only these
compound_detected <- compound_tables %>% group_by(Compound) %>% dplyr::filter(!(is.na(Area))) %>% summarise(n = n()) %>% pull(Compound)
met <- compound_tables %>% dplyr::filter(Compound %in% compound_detected)

# View(met)

# clean up environment
rm(compound_tables, compound_header_indices, lines, AMP_data, HMPAA_data)

``` 

Combine the metadata and metabolite data
```{r annotate data, include=FALSE}
data <- met %>% 
  select(Sample.Nr,  Name, Type, Area, Detection.Flags, Compound) %>% 
  left_join(meta %>% rename(Fraction = Type), by = c("Sample.Nr" = "Number.HPLC.Vial_corr")) %>% 
  mutate(Compound = factor(Compound, levels = c("MBOA", "AMP", "AMPO", "AAMPO", "HMPAA"))) #%>% 
  # mutate() # here multiply the samples required by 3

rm(met, meta)
```

Colors for plotting etc
```{r color vectors, include=FALSE}
Compound_colors <- setNames(c("darkblue", "maroon", "darkred", "firebrick1", "gold2"), nm = c("MBOA", "AMP", "AMPO", "AAMPO", "HMPAA"))

```

```{r, warning=FALSE, include=FALSE}
symnum.args <- list(cutpoints = c(0, 0.05, 1), symbols = c("*", "ns"))
```


```{r quick look at data, echo=F, message=F , warning=F, include = F}
# look at data including LMG1
data.96well <- data %>% filter(Exp == "25CMP16") %>% mutate(Treatment2 = ifelse(TP == "0h", paste0(Treatment, "_0h"), Treatment)) %>% 
  mutate(Treatment = factor(Treatment, levels = c("NBC", "LMX9231", "LMB2", "LMG1"))) %>% 
  filter(Compound != "AMP") #AMP is not reliably detected, so also not shown.

data.96well %>% group_by(Treatment2, TP, Compound, MBOA) %>% summarise(n = n())

TSBMBOA.96well.plot_MBOA <- data.96well %>% 
  dplyr::filter(MBOA == "TSB_MBOA", TP != "0h") %>% 
  ggplot(aes(x = Treatment, y = Area))+
  geom_bar(aes(fill = Compound), stat="summary", position="stack", size = 2, show.legend = TRUE) +
  geom_jitter(width = 0.1)+
  scale_fill_manual(values = Compound_colors) +
  # geom_point(aes(color = MBOA), position = "jitter") +
  theme_bw()+
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0 )) +
  facet_wrap(~Compound, scales = "free_y", nrow = 1)+
 labs(title = "Compounds detected 68 h 50% TSB + 500 µM MBOA",
       x = "",
       y = "concentration [Area]")
TSBMBOA.96well.plot_MBOA


# Detect also very little AAMPO for LMB2 but much more for LMX9231. AMP is very low for all of them. Not reliably detected.
# AMPO detected for LMX9231 and much more for LMB2. 
# MBOA no longer detected for LMB2. For LMG1 looks like not degraded and for LMX9231 detect MBOA but a bit less than for NBC. So get some but not complete degradation.



```


```{r combine data and plot for degradation 96-well plate, echo=F, message=F , warning=F}

data.96wellSel <- data %>% filter(Exp == "25CMP16", Treatment %in% c("NBC", "LMX9231", "LMB2")) %>% 
  mutate(Treatment = factor(Treatment, levels = c("NBC", "LMX9231", "LMB2"))) %>% 
  filter(Compound != "AMP") #AMP is not reliably detected, so also not shown.

TSBMBOA.96well.plot_MBOA_FigS3 <- data.96wellSel %>% 
  dplyr::filter(MBOA == "TSB_MBOA", TP != "0h") %>% 
  ggplot(aes(x = Treatment, y = Area))+
  geom_bar(aes(fill = Compound), stat="summary", position="dodge", size = 2, show.legend = TRUE) +
  # ggbeeswarm::geom_quasirandom(aes(fill = Compound), shape = 21,   width = 0.3, show.legend = FALSE)+
  ggbeeswarm::geom_quasirandom( width = 0.3, show.legend = FALSE)+
  geom_errorbar(stat = "summary", width=0.2) +
  theme_classic() +
  scale_y_continuous(expand = expansion(mult = c(0, .1)))+
  scale_fill_manual(values = Compound_colors) +
  theme_classic() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0, colour = "black"), 
        axis.text.y = element_text(colour = "black"), strip.background = element_blank()) +
  facet_wrap(~Compound, scales = "free_y", nrow = 1)+
 labs(title = "MBOA metabolization in complex medium in 96-well plate",
       x = "",
       y = "concentration [Area]")



# Statistik: 

data.stats <-  TSBMBOA.96well.plot_MBOA_FigS3$data  %>% group_by(Compound, Treatment) %>% filter(sum(!is.na(Area)) >=2) %>% ungroup() # here remove all teh ones that do not contain sufficient amounts of samples to detect
t.test <- compare_means(Area ~ Treatment, data = data.stats, group.by = "Compound", method = "t.test", p.adjust.method = "bonferroni") %>% 
  mutate(p.signif.sign = ifelse(p.adj <= 0.05, "*", "ns"))

# get the y-positions
y_pos <- data.stats %>% group_by(Compound) %>% summarise(y.position = max(Area, na.rm = T)*1.01)
t.test.ypos <- t.test  %>%  left_join(y_pos) %>% ungroup() %>%  filter(p.signif.sign != "ns") %>% group_by(Compound) %>%  mutate(y.position.plot = y.position + row_number()*y.position*0.09) %>% ungroup()

Final_plot_stats <- TSBMBOA.96well.plot_MBOA_FigS3 +
  theme(strip.background = element_blank())+
  stat_pvalue_manual(t.test.ypos , y.position = "y.position.plot", label = "p.signif.sign")
Final_plot_stats
# 
# 
# 
# # Detect also very little AAMPO for LMB2 but much more for LMX9231. AMP is very low for all of them. Not reliably detected and thus not shown.
# # AMPO detected for LMX9231 and much more for LMB2. 
# # MBOA no longer detected for LMB2. For LMG1 looks like not degraded and for LMX9231 detect MBOA but a bit less than for NBC. So get some but not complete degradation.
# 
# # add the stats for MBOA degradation
# 
# # Statistik: alle nicht significkant unterschiedlich. nicht inemal die AMPO LMB2 und NBC.
# data.stats <-  TSBMBOA.96well.plot_MBOA_FigS3$data  %>% group_by(Compound, Treatment) %>% filter(sum(!is.na(Area)) >=2) %>% ungroup() # here remove all teh ones that do not contain sufficient amounts of samples to detect
# t.test.96well <- compare_means(Area ~ Treatment, data = data.stats, group.by = "Compound", method = "t.test", p.adjust.method = "holm")
# 
# # get compact letter per group
# t.test.96well.letter <- t.test.96well %>%
#   mutate(comparison = paste(group1, group2, sep = "-")) %>%
#   group_by(Compound) %>%
#   summarise(
#     cld = list({
#       pvec <- setNames(p.adj, comparison)
#       multcompLetters(pvec)$Letters
#     })) %>%
#   unnest_longer(cld, values_to = "label") %>% rename(Treatment = label_id)
# 
# # get the y-positions
# y_pos <-  data.stats  %>%
#   group_by(Compound) %>%
#   summarise(y.position = max(Area, na.rm = TRUE) * 1.05, .groups = "drop")
# 
# cld_annot <- left_join(t.test.96well.letter, y_pos, by = c("Compound")) %>% mutate(group1 = Treatment, group2 = Treatment)
# 
# 
# Final_plot_stats <- TSBMBOA.96well.plot_MBOA_FigS3 +
#   stat_pvalue_manual(cld_annot, y.position = "y.position", label = "label", x= "group1", tip.length = 0)
# Final_plot_stats

# note that with p-value adjustment, AMPO LMB2 vs NBC and AAMPO LMB2 vs LMX9231 not significant.

#ggsave(plot = Localization_AMP, filename = "Localization_AMP_LMB2_Area.pdf",width = 13.2, height = 8, dpi = 300, scale = 1, units = "cm")
# ggsave(plot = TSBMBOA.96well.plot_MBOA_FigS3, filename = "Output/MBOA_deg_96well_68h_TSBMBOA.pdf", width = 20, height = 8.8, dpi = 300, scale = 1, units = "cm")
# ggsave(plot = TSBMBOA.96well.plot_MBOA_FigS3, filename = "Output/MBOA_deg_96well_68h_TSBMBOA.png", width = 20, height = 8.8, dpi = 300, scale = 1, units = "cm")

ggsave(plot = Final_plot_stats, filename = "Output/FigS3_MBOA_deg_96well_68h_TSBMBOA_stats.pdf", width = 20, height = 8, dpi = 300, scale = 1, units = "cm")
ggsave(plot = Final_plot_stats, filename = "Output/FigS3_MBOA_deg_96well_68h_TSBMBOA_stats.png", width = 20, height = 8, dpi = 300, scale = 1, units = "cm")
# ggsave(plot = combined_96well, filename = "Output/MBOA_deg_96well_68h_TSBMBOA_DMSO.pdf", width = 25, height = 18, dpi = 300, scale = 1, units = "cm")
# ggsave(plot = combined_96well, filename = "Output/MBOA_deg_96well_68h_TSBMBOA_DMSO.png", width = 25, height = 18, dpi = 300, scale = 1, units = "cm")
# a little MBOA detected in NBC 1/2 TSB-DMSO control? Check whether this is meaningful

```


```{r}
sessionInfo()
```


